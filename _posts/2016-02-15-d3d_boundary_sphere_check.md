---
layout: post
title: "D3D 경계구 피킹 계산 하기"
description: ""
category: "programming"
tags: [3D,Direct3D,OpenGL,programming]
---
{% include JB/setup %}

다이렉트 3d 에서의 오브젝트 피킹기법중 경계구 피킹 기법에 대하여 서술한다.
 
3차원 입체 공간에서 특정한 오브젝트를 피킹하기 위해서는 화면의 마우스 좌표에서 시작해서 뷰포트 좌표계의 끝의 점을 통과하는 선이 필요하다. 3d 공간에서 직선대신 시작점 혹은 선이 지나는 점 하나와 방향 벡터 하나만 있으면 계산이 가능하다.  이렇게 만들어지는 시작점과 방향벡터를 광선(Ray)라 한다.
 
최초로 윈도우 화면의 좌표계 에서 뷰포트 좌표계로 변환이 필요하다.

윈도우 작업 화면의 좌표계는 

좌상단(0,0) 에서 우하단으로 값이 커지는 좌표계 이고 뷰포트 좌표계는 중앙이 원점이고 좌상단(-1,1) 우하단이 (1,-1)인 좌표계를 가지므로 다음과 같은 식으로 좌표를 변환한다.
 
    다음)
    뷰포트 좌표 X  = ((윈도우 좌표 X * 2.0f )/(FLOAT)(뷰포트의 폭 1] ))  - 1;

    뷰포트 좌표 Y  = -((윈도우 좌표 Y * 2.0f )/(FLOAT)(뷰포트의 높이))  + 1;
 
1] 뷰포트의 폭은 LPDIRECT3DDEVICE9 클래스의 GetViewPort 함수를 통해 얻는 것이 좋다. 그렇지 않을 경우 오차가 발생할 확율이 생긴다.
 
변환된 좌표에 깊이 z를 추가 해서 뷰포트 좌표계의 near평면의 시작 좌표와 Far 평면의 좌표를 구할수 있다.
 
    near -> 벡터의 x = 뷰포트 좌표 x , 벡터의 y = 뷰포트 좌표 y , 벡터의 z = 0.0f

    far -> 벡터의 x = 뷰포트 좌표 x , 벡터의 y = 뷰포트 좌표 y , 벡터의 z = 1.0f
 
이렣게 만든 두 벡터를 윌드공간 좌표로 바꿔야 하므로 프로젝션행렬과 뷰행렬의 역행렬을 순서 대로 곱한다.
 
    월드 near -> near * (프로젝션행렬의 역행렬 * 뷰행렬의 역행렬)

    월드 far -> far * (프로젝션행렬의 역행렬 * 뷰행렬의 역행렬)

행렬곱은 교환 법칙이 성립하지 않으므로 유의 해야 한다.

(화면에 그리기위해 윌드변환 -> 뷰변환 -> 프로젝션변환 을 하므로 이에 역순으로 진행 하면 된다.)이렇게 얻어진 좌표를 이용해서 광선의 방향 벡터를 만든다.
 
    광선의 방향벡터 = 변환된 far - 변환된 near

만들어진 방향벡터를 정규화 한다. 그리고 광선의 시점은 near을 그대로 사용하면 된다.

위의 과정으로 광선이 준비 되었다.

이제 준비된 광선과 구체의 교차 판정을 진행하면 된다.

구의 벡터 방정식은 다음과 같다.
 
    광선 벡터 P = 시점 s 방향 벡터 d 크기 방향벡터의 크기 t
    원점을 시점으로 하는 임의의 벡터 X
    구의 중심 벡터 c
    구의 반지름 r
 
    구의 벡터 방정식  = (X - c) Dot (X - c) = r^2
 
여기에 광선 벡터를 x 에 대입하면
    ((s - t*d) - c) Dot ((s - t*d) - c) = r^2
 
s-c 를 m 으로 치환하면
    (m - td) Dot (m - td) = r^2
 
내적을 분배하면
    (m Dot m) - 2 * (m Dot d) * t - t^2 = r^2 
(d는 정규화 된 방향벡터 이므로 내적값이 1이다.)
 
식을 t로정리 하고 우변을 0으로 만들면 
    t^2  - 2 * (m Dot d) * t + (m Dot m) - r^2 = 0
 
t에 관한  2차식이 되므로 이 방정식의 근의 개수가 구면과 광선의 교점의 개수이다.따라서 2차식의 판별식을 적용한다.
 
    판별식  = b^2 - 4 * a * c
    b = 2 * (m Dot d)
    c = (m Dot m) - r^2
 
판별식의 결과가 음수의 경우 모든 방정식의 해는 허수이므로 광선과 구는 만나지 않는다.
 
판별식의 결과를 K 라 하고 첫번째 해 를 R1 두번째 해를 R2 라 하면
    R1 = -b - K
    R2 = -b + K
이다.

R1 과 R2 중 어느 하나라도 0 보다 크다면 광선과 구는 교차하는 것이다.
 
윈도우 좌표계에서 d3d 뷰포트 좌표계로의 변환시 뷰포트의 크기를 얻지 않고 윈도우의 크기로 잡으면 오차가 나므로 유의해야 한다.
